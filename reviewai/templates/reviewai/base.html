<!DOCTYPE html>
<html class="h-full bg-gray-100">
<head>
    <title>{% block title %}ReviewAI{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <!-- AOS Animate on Scroll JS -->
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    {% load static %}
    <link rel="icon" type="image/png" href="{% static 'reviewai/images/logo/reviewailogobluestarnobg.png' %}">
        <!--jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    {% comment %} <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.min.js"></script> {% endcomment %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    {% block extra_css %}{% endblock %}
</head>
<body class="h-full">
    <div class="min-h-full flex flex-col">
        
        <!-- Sidebar - Only show on user dashboard/history pages -->
        {% if request.resolver_match.url_name == 'user_dashboard' or request.resolver_match.url_name == 'history' %}
        <div class="hidden lg:fixed lg:inset-y-0 lg:z-50 lg:flex lg:w-64 lg:flex-col">
            <div class="flex grow flex-col gap-y-5 overflow-y-auto bg-white px-6 shadow-lg">
                <!-- Logo -->
                <div class="flex h-16 shrink-0 items-center border-b border-gray-200">
                    <h1 class="text-xl font-bold text-gray-800">
                        <a href="{% url 'reviewai:analyze' %}">ReviewAI</a>
                    </h1>
                </div>
                
                <!-- Navigation -->
                <nav class="flex flex-1 flex-col">
                    <ul role="list" class="flex flex-1 flex-col gap-y-2">
                        <!-- My Dashboard -->
                        <li>
                            <a href="{% url 'reviewai:user_dashboard' %}" 
                               class="{% if request.resolver_match.url_name == 'user_dashboard' %}bg-blue-50 text-blue-600 border-r-2 border-blue-600{% else %}text-gray-700 hover:text-blue-600 hover:bg-gray-50{% endif %} group flex gap-x-3 rounded-md p-2 text-sm leading-6 font-semibold">
                                <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l-1-3m1 3l-1-3m-16.5-3h16.5" />
                                </svg>
                                My Dashboard
                            </a>
                        </li>

                        <!-- Analysis History -->
                        <li>
                            <a href="{% url 'reviewai:history' %}" 
                               class="{% if request.resolver_match.url_name == 'history' %}bg-blue-50 text-blue-600 border-r-2 border-blue-600{% else %}text-gray-700 hover:text-blue-600 hover:bg-gray-50{% endif %} group flex gap-x-3 rounded-md p-2 text-sm leading-6 font-semibold">
                                <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Analysis History
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}


        <!-- Main content -->
        <div class="{% if request.resolver_match.url_name == 'user_dashboard' or request.resolver_match.url_name == 'history' %}lg:pl-64{% endif %} flex flex-col flex-1">
            <!-- Top bar -->
            <div class="sticky top-0 z-40 flex h-16 shrink-0 items-center gap-x-4 border-b border-gray-200 bg-white px-4 shadow-sm sm:gap-x-6 sm:px-6 lg:px-8">
                <!-- Mobile menu button -->
                {% if request.resolver_match.url_name == 'user_dashboard' or request.resolver_match.url_name == 'history' %}
                <button type="button" class="-m-2.5 p-2.5 text-gray-700 lg:hidden" onclick="toggleMobileMenu()">
                    <span class="sr-only">Open sidebar</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </button>
                {% endif %}

                <div class="flex flex-1 gap-x-4 self-stretch lg:gap-x-6" data-aos="fade-in">
                    <div class="flex flex-1 items-center">
                        {% if request.resolver_match.url_name == 'analyze' %}
                        <h1 class="text-xl font-bold text-gray-800">
                            <a href="{% url 'reviewai:analyze' %}">ReviewAI</a>
                        </h1>
                        {% elif request.resolver_match.url_name == 'user_dashboard' %}
                        <h1 class="text-xl font-semibold leading-6 text-gray-900">My Dashboard</h1>
                        {% elif request.resolver_match.url_name == 'history' %}
                        <h1 class="text-xl font-semibold leading-6 text-gray-900">Analysis History</h1>
                        {% endif %}
                    </div>
                    
                    <!-- User menu -->
                    {% if user.is_authenticated %}
                    <div class="flex items-center gap-x-4 lg:gap-x-6">
                        <div class="relative" x-data="{ open: false }">
                            <button type="button" 
                                    class="flex items-center gap-x-2 text-sm font-semibold leading-6 text-gray-900 hover:text-gray-600"
                                    @click="open = !open"
                                    @click.outside="open = false">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <span class="text-sm font-medium text-blue-600">{{ user.username|first|upper }}</span>
                                </div>
                                <span class="hidden lg:flex lg:items-center">
                                    <span class="ml-2 text-sm font-semibold leading-6 text-gray-900">{{ user.username }}</span>
                                    <svg class="ml-2 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                                    </svg>
                                </span>
                            </button>

                            <!-- Dropdown menu -->
                            <div x-show="open" 
                                x-transition:enter="transition ease-out duration-100"
                                x-transition:enter-start="transform opacity-0 scale-95"
                                x-transition:enter-end="transform opacity-100 scale-100"
                                x-transition:leave="transition ease-in duration-75"
                                x-transition:leave-start="transform opacity-100 scale-100"
                                x-transition:leave-end="transform opacity-0 scale-95"
                                class="absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-white py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
                                style="display: none;">
                                
                                <!-- User Badge - Show Admin or User -->
                                <div class="px-4 py-2 border-b border-gray-100">
                                    <div class="flex items-center">
                                        {% if user.is_staff or user.is_superuser %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            Admin
                                        </span>
                                        {% else %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            User
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- CONDITIONAL NAVIGATION BASED ON USER TYPE -->
                                {% if user.is_staff or user.is_superuser %}
                                    <!-- ADMIN USERS - Show Admin Dashboard Only -->
                                    <a href="{% url 'reviewai:admin_dashboard' %}" 
                                    class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        Admin Dashboard
                                    </a>

                                    <a href="{% url 'reviewai:admin_history' %}" 
                                    class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        All Reviews History
                                    </a>
                                {% else %}
                                    <!-- REGULAR USERS - Show User Dashboard and History -->
                                    <a href="{% url 'reviewai:user_dashboard' %}" 
                                    class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                        </svg>
                                        My Dashboard
                                    </a>

                                    <a href="{% url 'reviewai:history' %}" 
                                    class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        My Analysis History
                                    </a>
                                {% endif %}

                                <!-- Divider -->
                                <div class="border-t border-gray-100"></div>

                                <!-- Profile Settings -->
                                <a href="{% url 'users:profile' %}" 
                                class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    Profile Settings
                                </a>

                                <a href="{% url 'reviewai:developer_page' %}" 
                                    class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M16 18l6-6-6-6M8 6l-6 6 6 6"></path>
                                    </svg>
                                    Developer's Page
                                </a>

                                <!-- Logout -->
                                <a href="{% url 'users:logout' %}"
                                class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Logout
                                </a>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- Guest user - Login/Signup buttons -->
                    <div class="flex items-center space-x-3">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            Guest Mode
                        </span>
                        <a href="{% url 'users:login' %}" 
                           class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
                            Login
                        </a>
                        <a href="{% url 'users:register' %}" 
                           class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            Sign Up
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Messages -->
            {% comment %} {% if messages %}
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-4">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %} {% endcomment %}

            <!-- Page content -->
            <main class="flex-1 py-6 ">
                <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 ">
                    {% block content %}{% endblock %}
                </div>
            </main>
            

            <!-- CHATBOT TOGGLE BUTTON -->
            <button id="chatbot-toggle" 
                class="fixed bottom-6 right-6 bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center text-2xl shadow-lg hover:bg-blue-700 transition z-50"
                aria-label="FAQ Assistant">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9a3 3 0 015.468 0c.177.34.304.716.376 1.116.106.587-.057 1.208-.442 1.671a3.001 3.001 0 01-1.397.97 2.992 2.992 0 00-1.317.8M12 17h.01" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 21c4.97 0 9-4.03 9-9s-4.03-9-9-9S3 7.03 3 12s4.03 9 9 9z" />
                </svg>
            </button>

            <!-- CHATBOT BOX -->
            <div id="chatbot-box"
                class="hidden fixed bottom-24 right-6 w-96 h-[600px] bg-white border border-gray-300 rounded-2xl shadow-xl flex flex-col overflow-hidden z-50">

                <div class="bg-blue-600 text-white px-4 py-3 font-semibold flex justify-between items-center rounded-t-2xl">
                    <span>ReviewAI Assistant </span>
                    <button id="close-chatbot" class="text-white hover:text-gray-200 text-xl leading-none">&times;</button>
                </div>

                <!-- MSG -->
                <div id="chatbot-messages"
                    class="flex-1 overflow-y-auto p-4 space-y-3 scroll-smooth bg-gray-50">
                    <div class="bg-gray-100 text-gray-800 p-2 rounded-lg max-w-[80%]">
                        Hello! ðŸ‘‹ Iâ€™m <b>ReviewAI Assistant</b>. I can help answer FAQs about the system.
                    </div>
                </div>

                <!-- typing indicator-->
                <div id="typing-indicator" class="hidden text-gray-500 text-sm px-4 py-2 animate-pulse">
                    Bot is typing...
                </div>
            </div>



            <!--footer-->
            <footer class="bg-white border-t border-gray-200 flex-shrink-0" >
              <div class="max-w-6xl mx-auto px-4 py-8 ">
                    <div class="text-center">
                        <h3 class="font-bold text-gray-900 mb-4">
                        <a href="{% url 'reviewai:analyze' %}" class="hover:text-blue-600 transition-colors">ReviewAI</a>
                        </h3>
                      
                  <div class="flex justify-center gap-8 mb-4">
                    <a href="{% url 'reviewai:terms_of_use' %}" target="_blank" class="text-gray-600 hover:text-gray-900 hover:underline"
                        >Terms of Use</a
                    >
                    <a href="{% url 'reviewai:privacy_policy' %}" target="_blank"  class="text-gray-600 hover:text-gray-900 hover:underline"
                        >Privacy Policy</a
                    >
                    <a href="{% url 'reviewai:developer_page' %}" target="_blank" class="text-gray-600 hover:text-gray-900 hover:underline"
                        >Developer's Page</a
                    >
                  </div>
                  <p class="text-gray-500">
                    Copyright 2025 <span class="font-semibold">ReviewAI</span>
                  </p>
                </div>
              </div>
            </footer>
        </div>
        
    </div>

    <!-- Mobile Menu Overlay -->
    {% if request.resolver_match.url_name == 'user_dashboard' or request.resolver_match.url_name == 'history' %}
    <div id="mobile-menu" class="relative z-50 lg:hidden hidden" role="dialog">
        <div class="fixed inset-0 bg-gray-900/80"></div>
        <div class="fixed inset-0 flex">
            <div class="relative mr-16 flex w-full max-w-xs flex-1">
                <div class="absolute left-full top-0 flex w-16 justify-center pt-5">
                    <button type="button" class="-m-2.5 p-2.5" onclick="toggleMobileMenu()">
                        <span class="sr-only">Close sidebar</span>
                        <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="flex grow flex-col gap-y-5 overflow-y-auto bg-white px-6 pb-4">
                    <div class="flex h-16 shrink-0 items-center border-b border-gray-200">
                        <h1 class="text-xl font-bold text-gray-800">ReviewAI</h1>
                    </div>
                    <nav class="flex flex-1 flex-col">
                        <ul role="list" class="flex flex-1 flex-col gap-y-2">
                            <li>
                                <a href="{% url 'reviewai:user_dashboard' %}" 
                                   class="{% if request.resolver_match.url_name == 'user_dashboard' %}bg-blue-50 text-blue-600{% else %}text-gray-700{% endif %} group flex gap-x-3 rounded-md p-2 text-sm leading-6 font-semibold">
                                    <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l-1-3m1 3l-1-3m-16.5-3h16.5" />
                                    </svg>
                                    My Dashboard
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'reviewai:history' %}" 
                                   class="{% if request.resolver_match.url_name == 'history' %}bg-blue-50 text-blue-600{% else %}text-gray-700{% endif %} group flex gap-x-3 rounded-md p-2 text-sm leading-6 font-semibold">
                                    <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Analysis History
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            AOS.init({
            duration: 800, // animation duration in ms
            once: true,    // whether animation should happen only once
            });
        });
    </script>

    <!-- Alpine.js for dropdown functionality -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Mobile menu toggle script -->
    <script>
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
        const Toast = Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 2500,
            timerProgressBar: true,
        });

        {% if messages %}
            {% for message in messages %}
            Toast.fire({
                icon: "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}",
                title: "{{ message|escapejs }}"
            });
            {% endfor %}
        {% endif %}
        });
    </script>
    <script>
        const AI_LOGO = "{% static 'reviewai/images/logo/reviewailogobluestarnobg.png' %}";
    </script>

    <script src="{% static 'reviewai/js/chatbot.js' %}"></script>

    <!-- PDF Export Function (Global) -->
    <script>
        function exportUserDashboardToPDF() {
            // Show loading state
            Swal.fire({
                title: 'Generating PDF...',
                html: 'Please wait while we create your dashboard report',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                // Check if jsPDF is loaded
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF library not loaded');
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                let yPosition = margin;

                // Helper function to add new page if needed
                const checkPageBreak = (requiredHeight) => {
                    if (yPosition + requiredHeight > pageHeight - margin) {
                        doc.addPage();
                        yPosition = margin;
                        return true;
                    }
                    return false;
                };

                // Get data from page
                const username = document.querySelector('[data-username]')?.dataset.username || 'User';
                const totalReviews = document.querySelector('[data-total-reviews]')?.textContent || '0';
                const fakeCount = document.querySelector('[data-fake-count]')?.textContent || '0';
                const genuineCount = document.querySelector('[data-genuine-count]')?.textContent || '0';
                const recentCount = document.querySelector('[data-recent-count]')?.textContent || '0';

                // Header with gradient effect (simulated)
                doc.setFillColor(59, 130, 246); // Blue
                doc.rect(0, 0, pageWidth, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('ReviewAI Dashboard', margin, 20);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(username, margin, 30);
                doc.text(new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                }), pageWidth - margin, 30, { align: 'right' });

                yPosition = 50;

                // Statistics Section
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Overview Statistics', margin, yPosition);
                yPosition += 10;

                // Stats boxes
                const stats = [
                    { label: 'Total Reviews', value: totalReviews, color: [59, 130, 246] },
                    { label: 'Fake Detected', value: fakeCount, color: [239, 68, 68] },
                    { label: 'Genuine Found', value: genuineCount, color: [34, 197, 94] },
                    { label: 'Last 30 Days', value: recentCount, color: [168, 85, 247] }
                ];

                const boxWidth = (pageWidth - 2 * margin - 15) / 2;
                const boxHeight = 25;
                let xPos = margin;
                
                stats.forEach((stat, index) => {
                    if (index === 2) {
                        xPos = margin;
                        yPosition += boxHeight + 5;
                    }
                    
                    // Box background
                    doc.setFillColor(stat.color[0], stat.color[1], stat.color[2]);
                    doc.setDrawColor(stat.color[0], stat.color[1], stat.color[2]);
                    doc.roundedRect(xPos, yPosition, boxWidth, boxHeight, 3, 3, 'FD');
                    
                    // Text
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(stat.label, xPos + 5, yPosition + 8);
                    
                    doc.setFontSize(18);
                    doc.setFont(undefined, 'bold');
                    doc.text(stat.value, xPos + 5, yPosition + 18);
                    
                    xPos += boxWidth + 5;
                });

                yPosition += boxHeight + 15;
                checkPageBreak(20);

                // Get products from page - FIXED LAYOUT
                const productElements = document.querySelectorAll('[data-product-name]');
                if (productElements.length > 0) {
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.text('Most Analyzed Products', margin, yPosition);
                    yPosition += 8;

                    doc.setFontSize(10);
                    
                    productElements.forEach((el, index) => {
                        const productName = el.dataset.productName;
                        const productCount = el.dataset.productCount;
                        
                        // Calculate required height based on text wrapping
                        const maxProductWidth = pageWidth - 2 * margin - 45; // Space for number and count
                        const wrappedLines = doc.splitTextToSize(productName, maxProductWidth);
                        const lineHeight = 5;
                        const requiredHeight = Math.max(10, wrappedLines.length * lineHeight + 4);
                        
                        checkPageBreak(requiredHeight + 2);
                        
                        // Background box
                        doc.setFillColor(240, 240, 240);
                        doc.roundedRect(margin, yPosition, pageWidth - 2 * margin, requiredHeight, 2, 2, 'F');
                        
                        // Rank number (left side)
                        doc.setTextColor(100, 116, 139);
                        doc.setFont(undefined, 'normal');
                        doc.text((index + 1).toString(), margin + 3, yPosition + (requiredHeight / 2) + 1.5);
                        
                        // Product name (middle - wrapped if needed)
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'bold');
                        
                        // Center text vertically based on number of lines
                        const textStartY = yPosition + (requiredHeight / 2) - ((wrappedLines.length - 1) * lineHeight / 2) + 1.5;
                        
                        wrappedLines.forEach((line, lineIndex) => {
                            doc.text(line, margin + 12, textStartY + (lineIndex * lineHeight));
                        });
                        
                        // Review count (right side - aligned to middle)
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(100, 116, 139);
                        doc.text(productCount, pageWidth - margin - 5, yPosition + (requiredHeight / 2) + 1.5, { align: 'right' });
                        
                        yPosition += requiredHeight + 2;
                    });
                    yPosition += 3;
                }

                // Get recent reviews from page - FIXED WITH TRUNCATION
                const reviewElements = document.querySelectorAll('[data-review-id]');
                if (reviewElements.length > 0) {
                    checkPageBreak(20);
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.text('Recent Reviews', margin, yPosition);
                    yPosition += 10;

                    reviewElements.forEach((el, index) => {
                        let reviewProduct = el.dataset.reviewProduct || 'Unknown Product';
                        let reviewText = el.dataset.reviewText || 'No review text';
                        const reviewResult = el.dataset.reviewResult;
                        const reviewConfidence = el.dataset.reviewConfidence;

                        // TRUNCATE LONG PRODUCT NAMES (max 60 chars)
                        if (reviewProduct.length > 60) {
                            reviewProduct = reviewProduct.substring(0, 57) + '...';
                        }

                        // TRUNCATE LONG REVIEW TEXT (max 150 chars)
                        if (reviewText.length > 150) {
                            reviewText = reviewText.substring(0, 147) + '...';
                        }

                        const maxWidth = pageWidth - 2 * margin - 8;

                        // Set font BEFORE splitting text
                        doc.setFontSize(11);
                        doc.setFont(undefined, 'bold');
                        const productLines = doc.splitTextToSize(reviewProduct, maxWidth);

                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        const reviewLines = doc.splitTextToSize(reviewText, maxWidth);

                        // Limit to 2 lines for product name, 3 lines for review
                        const limitedProductLines = productLines.slice(0, 2);
                        const limitedReviewLines = reviewLines.slice(0, 3);

                        // Calculate heights
                        const productHeight = limitedProductLines.length * 5;
                        const reviewHeight = limitedReviewLines.length * 4.5;
                        const statusHeight = 6;
                        const padding = 12;

                        const boxHeight = productHeight + reviewHeight + statusHeight + padding;

                        checkPageBreak(boxHeight + 4);

                        // Box colors
                        if (reviewResult === 'fake' || reviewResult === 'likely_fake') {
                            doc.setDrawColor(239, 68, 68);
                            doc.setFillColor(254, 242, 242);
                        } else if (reviewResult === 'genuine' || reviewResult === 'likely_genuine') {
                            doc.setDrawColor(34, 197, 94);
                            doc.setFillColor(240, 253, 244);
                        } else {
                            doc.setDrawColor(234, 179, 8);
                            doc.setFillColor(254, 252, 232);
                        }

                        // Draw box
                        doc.roundedRect(margin, yPosition, pageWidth - 2 * margin, boxHeight, 3, 3, 'FD');

                        let currentY = yPosition + 6;

                        // Product name (BOLD, max 2 lines)
                        doc.setFontSize(11);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0);
                        limitedProductLines.forEach(line => {
                            doc.text(line, margin + 4, currentY);
                            currentY += 5;
                        });

                        currentY += 2;

                        // Review text (NORMAL, max 3 lines)
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(75, 85, 99);
                        limitedReviewLines.forEach(line => {
                            doc.text(line, margin + 4, currentY);
                            currentY += 4.5;
                        });

                        // Status badge at bottom
                        const bottomY = yPosition + boxHeight - 4;
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'bold');

                        let statusText = 'WARNING';
                        let statusColor = [161, 98, 7];

                        if (reviewResult === 'fake' || reviewResult === 'likely_fake') {
                            statusText = 'FAKE';
                            statusColor = [185, 28, 28];
                        } else if (reviewResult === 'genuine' || reviewResult === 'likely_genuine') {
                            statusText = 'GENUINE';
                            statusColor = [22, 163, 74];
                        }

                        doc.setTextColor(...statusColor);
                        doc.text(statusText, margin + 4, bottomY);

                        // Confidence
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(107, 114, 128);
                        doc.text(reviewConfidence + ' confidence', margin + 30, bottomY);

                        yPosition += boxHeight + 4;
                    });
                }

                // Footer on all pages
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(156, 163, 175);
                    doc.setFont(undefined, 'normal');
                    doc.text(
                        `ReviewAI Dashboard Report - Page ${i} of ${totalPages}`,
                        pageWidth / 2,
                        pageHeight - 10,
                        { align: 'center' }
                    );
                }

                // Save PDF
                doc.save('ReviewAI_Dashboard_' + username + '_' + new Date().toISOString().split('T')[0] + '.pdf');
                
                Swal.fire({
                    icon: 'success',
                    title: 'PDF Generated!',
                    text: 'Your dashboard report has been downloaded successfully.',
                    timer: 3000,
                    showConfirmButton: false
                });
                
            } catch (error) {
                console.error('PDF generation error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Generation Failed',
                    text: 'Error: ' + error.message + '. Please ensure all libraries are loaded.',
                });
            }
        }
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>